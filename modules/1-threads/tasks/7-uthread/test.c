#include "uthread.h"
#include <stdio.h>

// Функция первого потока
void* thread_func1(void* arg) {
    int id = *(int*)arg;
    
    for (int i = 0; i < 5; i++) {
        printf("  [Поток %d] Итерация %d\n", id, i);
        uthread_yield();  // Отдаём управление другому потоку
    }
    
    printf("  [Поток %d] Завершился\n", id);
    return NULL;
}

// Функция второго потока
void* thread_func2(void* arg) {
    int id = *(int*)arg;
    
    for (int i = 0; i < 3; i++) {
        printf("  [Поток %d] Шаг %d\n", id, i);
        uthread_yield();  // Отдаём управление
    }
    
    printf("  [Поток %d] Завершился\n", id);
    return NULL;
}

// Функция третьего потока
void* thread_func3(void* arg) {
    int id = *(int*)arg;
    
    for (int i = 0; i < 4; i++) {
        printf("  [Поток %d] Работа %d\n", id, i);
        uthread_yield();  // Отдаём управление
    }
    
    printf("  [Поток %d] Завершился\n", id);
    return NULL;
}

int main() {
    printf("=== Демонстрация пользовательских потоков ===\n\n");
    
    uthread_t t1, t2, t3;
    int id1 = 1, id2 = 2, id3 = 3;
    
    // Создаём три потока
    printf("Создание потоков...\n");
    if (uthread_create(&t1, thread_func1, &id1) != 0) {
        fprintf(stderr, "Ошибка создания потока 1\n");
        return 1;
    }
    
    if (uthread_create(&t2, thread_func2, &id2) != 0) {
        fprintf(stderr, "Ошибка создания потока 2\n");
        return 1;
    }
    
    if (uthread_create(&t3, thread_func3, &id3) != 0) {
        fprintf(stderr, "Ошибка создания потока 3\n");
        return 1;
    }
    
    printf("\nЗапуск планировщика...\n\n");
    
    // КЛЮЧЕВОЙ МОМЕНТ: Главный поток тоже должен участвовать в планировании
    // Первый вызов yield переключит нас на первый созданный поток
    uthread_yield();
    
    // После того, как все потоки завершатся и yield вернёт нас сюда
    printf("\n=== Все потоки завершились ===\n");
    
    return 0;
}

/* 
ОЖИДАЕМЫЙ ВЫВОД (примерно):
=== Демонстрация пользовательских потоков ===

Создание потоков...

Запуск планировщика...

  [Поток 1] Итерация 0
  [Поток 2] Шаг 0
  [Поток 3] Работа 0
  [Поток 1] Итерация 1
  [Поток 2] Шаг 1
  [Поток 3] Работа 1
  [Поток 1] Итерация 2
  [Поток 2] Шаг 2
  [Поток 3] Работа 2
  [Поток 1] Итерация 3
  [Поток 2] Завершился
  [Поток 3] Работа 3
  [Поток 1] Итерация 4
  [Поток 3] Завершился
  [Поток 1] Завершился

=== Все потоки завершились ===

Видно, что потоки переключаются друг с другом (не последовательно!)
*/
